<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Blend - Precision Coffee</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-espresso: #362D26; --color-crema: #D4A574; --color-milk: #F5F0E8;
            --color-steam: #FAFAFA; --color-sienna: #A0522D; --color-danger: #DC143C;
            --color-brewy: #6F4E37; --color-brewy-light: #8B7355; --color-chat-bg: #FFF9F5;
            --color-user-msg: #E8F4E8; --color-brewy-msg: #FFF5EB;
            --font-display: 'Playfair Display', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --shadow-soft: 0 4px 20px rgba(54, 45, 38, 0.08);
            --shadow-elevated: 0 8px 40px rgba(54, 45, 38, 0.12);
            --radius-sm: 8px; --radius-md: 16px; --radius-lg: 24px; --radius-full: 9999px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font-body); background: var(--color-milk); color: var(--color-espresso); -webkit-font-smoothing: antialiased; }
        #app { height: 100%; display: flex; flex-direction: column; max-width: 430px; margin: 0 auto; background: var(--color-steam); box-shadow: var(--shadow-elevated); position: relative; }
        
        /* HEADER */
        .header { background: var(--color-espresso); padding: 44px 16px 12px; display: flex; align-items: center; justify-content: space-between; }
        .header-brand { display: flex; align-items: center; gap: 10px; }
        .header-brewy-icon { width: 36px; height: 36px; border-radius: 50%; }
        .header-brand-text { display: flex; flex-direction: column; }
        .header-brand-name { font-family: var(--font-display); font-size: 18px; font-weight: 600; color: white; line-height: 1.1; }
        .header-brand-tagline { font-size: 10px; color: rgba(255,255,255,0.7); }
        .header-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: var(--radius-full); border: none; color: white; cursor: pointer; transition: background 0.2s; }
        .header-btn:hover { background: rgba(255,255,255,0.2); }
        .header-btn svg { width: 20px; height: 20px; }
        .header-title { font-family: var(--font-display); font-size: 20px; font-weight: 600; color: white; }
        .header-spacer { width: 40px; }
        
        /* SCREENS */
        .screen { flex: 1; overflow-y: auto; display: none; flex-direction: column; }
        .screen.active { display: flex; }
        
        /* NAV BAR */
        .nav-bar { display: flex; background: white; border-top: 1px solid #EEE; padding: 8px 0; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 8px; cursor: pointer; transition: all 0.2s; border: none; background: none; }
        .nav-item.active { color: var(--color-sienna); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .nav-item span { font-size: 11px; font-weight: 600; }
        
        /* ========== HOME PAGE - BREWY CHAT ========== */
        .home-container { flex: 1; display: flex; flex-direction: column; background: var(--color-chat-bg); overflow: hidden; }
        
        /* WELCOME VIEW */
        .welcome-view { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .welcome-view.hidden { display: none; }
        .video-container { width: 200px; height: 200px; border-radius: 50%; overflow: hidden; margin-bottom: 24px; box-shadow: 0 8px 40px rgba(111,78,55,0.3); }
        .video-container video { width: 100%; height: 100%; object-fit: cover; }
        .welcome-text { margin-bottom: 40px; }
        .welcome-title { font-family: var(--font-display); font-size: 32px; font-weight: 700; color: var(--color-brewy); }
        .welcome-subtitle { font-size: 14px; color: #888; margin-top: 4px; }
        .menu-btn-large { padding: 16px 48px; background: var(--color-sienna); color: white; border: none; border-radius: var(--radius-full); font-size: 18px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.3s; box-shadow: 0 4px 20px rgba(160,82,45,0.4); }
        .menu-btn-large:hover { transform: scale(1.05); box-shadow: 0 6px 30px rgba(160,82,45,0.5); }
        .menu-btn-large span { font-size: 24px; }
        
        /* CHAT VIEW */
        .chat-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .chat-view.hidden { display: none; }
        .chat-back-btn-container { padding: 8px 16px; background: white; border-bottom: 1px solid #EEE; }
        .back-to-menu-btn { background: none; border: none; color: var(--color-sienna); font-size: 13px; font-weight: 600; cursor: pointer; padding: 4px 0; }
        .back-to-menu-btn:hover { text-decoration: underline; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; justify-content: flex-end; }
        
        /* CHAT INPUT */
        .chat-input-area { padding: 12px 16px; background: white; border-top: 1px solid #EEE; }
        .chat-input-row { display: flex; gap: 10px; align-items: flex-end; }
        .chat-input { flex: 1; padding: 12px 16px; border: 2px solid #EEE; border-radius: var(--radius-full); font-size: 14px; font-family: var(--font-body); resize: none; max-height: 80px; transition: border-color 0.2s; }
        .chat-input:focus { outline: none; border-color: var(--color-crema); }
        .chat-send-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--color-sienna); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; flex-shrink: 0; }
        .chat-send-btn:hover { transform: scale(1.05); }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .chat-header { padding: 20px; text-align: center; background: linear-gradient(180deg, white 0%, var(--color-chat-bg) 100%); }
        .brewy-avatar { width: 100px; height: 120px; margin: 0 auto 12px; position: relative; }
        .brewy-svg { width: 100%; height: 100%; filter: drop-shadow(0 4px 8px rgba(111,78,55,0.3)); }
        .brewy-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 4px 8px rgba(111,78,55,0.3)); }
        .brewy-bean { font-size: 60px; filter: drop-shadow(0 4px 8px rgba(111,78,55,0.3)); }
        .mini-brewy { display: inline-block; width: 20px; height: 24px; vertical-align: middle; margin-right: 4px; }
        .brewy-face { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }
        .brewy-title { font-family: var(--font-display); font-size: 24px; font-weight: 700; color: var(--color-brewy); }
        .brewy-subtitle { font-size: 13px; color: #888; margin-top: 4px; }
        
        .message { max-width: 85%; margin-bottom: 12px; animation: msgIn 0.3s ease; }
        @keyframes msgIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.brewy { align-self: flex-start; }
        .message.user { align-self: flex-end; margin-left: auto; }
        .message-bubble { padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; }
        .message.brewy .message-bubble { background: var(--color-brewy-msg); border-bottom-left-radius: 4px; }
        .message.user .message-bubble { background: var(--color-user-msg); border-bottom-right-radius: 4px; }
        .message-sender { font-size: 11px; font-weight: 600; color: #888; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .mini-bean { font-size: 14px; }
        .mini-brewy-img { width: 18px; height: 18px; object-fit: contain; vertical-align: middle; margin-right: 4px; }
        .mini-brewy-icon { width: 20px; height: 20px; vertical-align: middle; margin-right: 4px; border-radius: 50%; }
        
        /* RECIPE CARD */
        .recipe-card { background: white; border-radius: var(--radius-lg); padding: 16px; margin: 12px 0; box-shadow: var(--shadow-soft); border: 2px solid var(--color-crema); }
        .recipe-card-title { font-weight: 700; color: var(--color-espresso); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .recipe-params { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .recipe-param { background: var(--color-milk); padding: 10px; border-radius: var(--radius-sm); text-align: center; }
        .recipe-param-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .recipe-param-value { font-size: 16px; font-weight: 700; color: var(--color-espresso); margin-top: 2px; }
        
        /* ADJUSTMENT OPTIONS */
        .adjustment-options { display: flex; gap: 8px; margin-top: 16px; justify-content: center; }
        .adjust-btn { padding: 10px 16px; background: var(--color-milk); border: 2px solid #DDD; border-radius: var(--radius-full); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .adjust-btn:hover { border-color: var(--color-crema); background: white; }
        .adjust-btn.stronger { color: #8B4513; }
        .adjust-btn.smoother { color: #4A90A4; }
        .adjust-btn.brighter { color: #DAA520; }
        
        .recipe-actions { display: flex; gap: 10px; margin-top: 12px; }
        .recipe-btn { flex: 1; padding: 12px; border-radius: var(--radius-full); font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; border: none; }
        .recipe-btn.primary { background: var(--color-sienna); color: white; }
        .recipe-btn.secondary { background: var(--color-milk); color: var(--color-espresso); border: 2px solid #DDD; }
        
        /* CHAT INPUT */
        .chat-input-area { padding: 12px 16px; background: white; border-top: 1px solid #EEE; }
        .chat-input-row { display: flex; gap: 10px; align-items: flex-end; }
        .chat-input { flex: 1; padding: 12px 16px; border: 2px solid #EEE; border-radius: var(--radius-full); font-size: 14px; resize: none; max-height: 100px; transition: border-color 0.2s; }
        .chat-input:focus { outline: none; border-color: var(--color-crema); }
        .chat-send-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--color-sienna); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .chat-send-btn:hover { transform: scale(1.05); }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* QUICK ACTIONS */
        .quick-actions { padding: 12px 16px 0; display: flex; gap: 8px; flex-wrap: wrap; }
        .quick-action-btn { padding: 8px 16px; background: white; border: 2px solid #EEE; border-radius: var(--radius-full); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .quick-action-btn:hover { border-color: var(--color-crema); background: var(--color-milk); }
        .design-btn { padding: 14px 20px; background: linear-gradient(135deg, var(--color-sienna) 0%, #8B4513 100%); color: white; border: none; border-radius: var(--radius-lg); font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 16px rgba(160,82,45,0.3); margin: 16px; transition: transform 0.2s; }
        .design-btn:hover { transform: translateY(-2px); }
        
        /* ========== CUSTOMIZE PAGE ========== */
        .customize-container { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; }
        .dashboard { background: white; padding: 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); margin-bottom: 16px; }
        .dashboard-status { text-align: center; margin-bottom: 16px; }
        .status-badge { display: inline-block; padding: 6px 16px; border-radius: var(--radius-full); background: var(--color-espresso); color: white; font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
        .status-badge.heating { background: var(--color-danger); }
        .status-badge.pre-infusion { background: #D2691E; }
        .status-badge.extraction { background: #8B4513; }
        .status-badge.frothing { background: #00BCD4; }
        .status-badge.offline { background: #888; }
        .status-badge.brewing { background: #4CAF50; }
        .dashboard-metrics { display: flex; justify-content: space-between; gap: 12px; }
        .metric { flex: 1; text-align: center; padding: 12px 8px; background: var(--color-milk); border-radius: var(--radius-md); }
        .metric-label { font-size: 10px; font-weight: 500; color: #888; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 4px; }
        .metric-value { font-size: 20px; font-weight: 700; color: var(--color-espresso); }
        .metric-unit { font-size: 11px; color: #888; }
        
        .section-card { background: white; border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-soft); }
        .section-header { font-family: var(--font-display); font-size: 18px; font-weight: 600; color: var(--color-espresso); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .param-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #F0F0F0; }
        .param-row:last-child { border-bottom: none; }
        .param-label { font-size: 14px; font-weight: 500; color: #555; }
        .param-controls { display: flex; align-items: center; gap: 12px; }
        .param-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--color-milk); color: var(--color-espresso); font-size: 20px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .param-btn:hover { background: var(--color-crema); }
        .param-value { min-width: 70px; text-align: center; font-size: 16px; font-weight: 700; color: var(--color-espresso); }
        .milk-selector { display: flex; gap: 10px; margin-bottom: 16px; }
        .milk-option { flex: 1; padding: 14px 10px; border: 2px solid #EEE; border-radius: var(--radius-md); background: white; text-align: center; font-size: 14px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; }
        .milk-option.active { border-color: var(--color-sienna); background: var(--color-sienna); color: white; }
        
        .bottom-bar { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: white; padding: 16px 20px; border-top: 1px solid #EEE; display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 16px; border-radius: var(--radius-full); font-size: 15px; font-weight: 700; cursor: pointer; border: none; transition: all 0.2s; }
        .action-btn.primary { background: linear-gradient(135deg, var(--color-sienna) 0%, #8B4513 100%); color: white; }
        .action-btn.secondary { background: var(--color-milk); color: var(--color-espresso); }
        .action-btn.danger { background: var(--color-danger); color: white; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* BREWING ANIMATION */
        .brewing-overlay { display: none; position: absolute; inset: 0; background: rgba(255,255,255,0.98); z-index: 100; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .brewing-overlay.active { display: flex; }
        .brewing-icon { font-size: 48px; animation: brew-pulse 1.5s ease-in-out infinite; }
        @keyframes brew-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .brewing-phase { font-size: 24px; font-weight: 700; color: var(--color-espresso); margin: 12px 0; }
        .brewing-timer { font-size: 48px; font-weight: 700; color: var(--color-sienna); font-variant-numeric: tabular-nums; }
        
        /* Brewing Parameters Display */
        .brewing-params-display { display: flex; gap: 16px; margin: 20px 0; flex-wrap: wrap; justify-content: center; }
        .brewing-param-row { background: var(--color-milk); padding: 12px 20px; border-radius: var(--radius-md); text-align: center; min-width: 90px; }
        .brewing-param-label { display: block; font-size: 11px; color: #666; margin-bottom: 4px; }
        .brewing-param-value { display: block; font-size: 18px; font-weight: 700; color: var(--color-espresso); }
        
        /* Target Recipe Display */
        .brewing-target-display { background: linear-gradient(135deg, #FFF5EB 0%, #FFF0E0 100%); padding: 16px 20px; border-radius: var(--radius-md); margin: 16px 0; width: 100%; max-width: 300px; border: 2px solid var(--color-crema); }
        .brewing-target-title { font-size: 12px; font-weight: 700; color: var(--color-sienna); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; text-align: center; }
        .brewing-target-params { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
        .brewing-target-params span { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .brewing-target-params span:last-child, .brewing-target-params span:nth-last-child(2) { border-bottom: none; }
        
        /* Stop Button */
        .stop-brew-btn { margin-top: 24px; width: 200px; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px 24px; font-size: 16px; }
        
        /* Brew Completion State */
        .brew-complete { text-align: center; animation: fadeIn 0.5s ease; }
        .brew-complete-icon { font-size: 80px; animation: celebrate 0.6s ease; }
        @keyframes celebrate { 0% { transform: scale(0) rotate(-10deg); } 50% { transform: scale(1.2) rotate(5deg); } 100% { transform: scale(1) rotate(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .brew-complete-title { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--color-espresso); margin: 16px 0 8px; }
        .brew-complete-volume { font-size: 18px; color: var(--color-sienna); font-weight: 600; }
        .brew-complete-message { font-size: 14px; color: #666; margin-top: 8px; }
        .brewing-overlay.complete { background: linear-gradient(135deg, #FFF9F5 0%, #FFF5EB 100%); }
        .brewing-icon { font-size: 80px; animation: brew-pulse 1.5s ease-in-out infinite; }
        @keyframes brew-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .brewing-phase { font-family: var(--font-display); font-size: 24px; font-weight: 700; color: var(--color-sienna); margin-top: 16px; }
        .brewing-timer { font-size: 40px; font-weight: 700; color: var(--color-espresso); margin-top: 8px; }
        
        /* ========== MACHINE PAGE ========== */
        .machine-container { flex: 1; overflow-y: auto; padding: 20px; }
        .machine-card { background: white; border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-soft); }
        .machine-card-title { font-family: var(--font-display); font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .connection-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .connection-dot { width: 12px; height: 12px; border-radius: 50%; background: #888; }
        .connection-dot.connected { background: #4CAF50; }
        .connection-dot.disconnected { background: var(--color-danger); }
        .connection-text { font-size: 14px; font-weight: 500; }
        .ip-input-group { display: flex; gap: 10px; }
        .ip-input { flex: 1; padding: 12px 16px; border: 2px solid #EEE; border-radius: var(--radius-md); font-size: 14px; font-family: monospace; }
        .ip-input:focus { outline: none; border-color: var(--color-crema); }
        .connect-btn { padding: 12px 20px; background: var(--color-espresso); color: white; border: none; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; }
        
        /* ========== SAVED RECIPES PAGE ========== */
        .recipes-container { flex: 1; overflow-y: auto; padding: 20px; }
        .recipes-empty { text-align: center; padding: 60px 20px; color: #888; }
        .recipes-empty-icon { font-size: 60px; margin-bottom: 16px; opacity: 0.5; }
        .saved-recipe-card { background: white; border-radius: var(--radius-lg); padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow-soft); cursor: pointer; transition: transform 0.2s; }
        .saved-recipe-card:hover { transform: translateY(-2px); }
        .saved-recipe-name { font-weight: 700; font-size: 16px; color: var(--color-espresso); margin-bottom: 8px; }
        .saved-recipe-params { display: flex; gap: 12px; flex-wrap: wrap; }
        .saved-recipe-param { font-size: 12px; color: #666; background: var(--color-milk); padding: 4px 10px; border-radius: var(--radius-full); }
        .saved-recipe-actions { display: flex; gap: 8px; margin-top: 12px; }
        .saved-recipe-btn { padding: 8px 16px; border-radius: var(--radius-full); font-size: 13px; font-weight: 600; cursor: pointer; border: none; }
        .saved-recipe-btn.brew { background: var(--color-sienna); color: white; }
        .saved-recipe-btn.edit { background: var(--color-milk); color: var(--color-espresso); }
        .saved-recipe-btn.delete { background: none; color: var(--color-danger); }
        
        /* SAVE RECIPE MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: var(--radius-lg); padding: 24px; width: 100%; max-width: 350px; }
        .modal-title { font-family: var(--font-display); font-size: 20px; font-weight: 700; margin-bottom: 16px; }
        .modal-input { width: 100%; padding: 12px 16px; border: 2px solid #EEE; border-radius: var(--radius-md); font-size: 14px; margin-bottom: 16px; }
        .modal-input:focus { outline: none; border-color: var(--color-crema); }
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: var(--radius-full); font-weight: 600; cursor: pointer; border: none; }
        .modal-btn.cancel { background: var(--color-milk); color: var(--color-espresso); }
        .modal-btn.save { background: var(--color-sienna); color: white; }
        
        /* TOAST */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--color-espresso); color: white; padding: 14px 24px; border-radius: var(--radius-full); font-size: 14px; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 300; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--color-danger); }
        .toast.success { background: #4CAF50; }
        
        .hidden { display: none !important; }
        
        /* TYPING INDICATOR */
        .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; }
        .typing-dot { width: 8px; height: 8px; background: var(--color-brewy-light); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }
    </style>
</head>
<body>
    <div id="app">
        <!-- ========== HOME PAGE (BREWY CHAT) ========== -->
        <div id="screen-home" class="screen active">
            <div class="header">
                <div class="header-brand">
                    <img src="data:image/png;base64,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" class="header-brewy-icon" alt="Brewy">
                    <div class="header-brand-text">
                        <span class="header-brand-name">Brewy</span>
                        <span class="header-brand-tagline">Your Barista Companion</span>
                    </div>
                </div>
                <button class="header-btn" onclick="openQRModal()" title="Share QR Code">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><rect x="18" y="14" width="3" height="3"/><rect x="14" y="18" width="3" height="3"/><rect x="18" y="18" width="3" height="3"/></svg>
                </button>
            </div>
            <div class="home-container">
                <!-- WELCOME VIEW with Video -->
                <div id="welcome-view" class="welcome-view">
                    <div class="video-container">
                        <video id="brewy-video" autoplay loop muted playsinline>
                            <source src="brewy-animation.mp4" type="video/mp4">
                        </video>
                    </div>
                    <div class="welcome-text">
                        <div class="welcome-title">Brewy</div>
                        <div class="welcome-subtitle">Your Barista Companion</div>
                    </div>
                    <button class="menu-btn-large" onclick="startMenuFlow()">
                        <span>üìã</span> View Menu
                    </button>
                </div>
                
                <!-- CHAT VIEW (hidden initially) -->
                <div id="chat-view" class="chat-view hidden">
                    <div class="chat-back-btn-container">
                        <button class="back-to-menu-btn" onclick="backToMenu()">‚Üê Back to Menu</button>
                    </div>
                    <div id="chat-messages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <div class="chat-input-row">
                            <textarea id="chat-input" class="chat-input" placeholder="Tell Brewy what you'd like... (e.g., 'make it stronger' or 'less bitter')" rows="1" onkeydown="handleChatKeydown(event)"></textarea>
                            <button id="chat-send-btn" class="chat-send-btn" onclick="sendChatMessage()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== CUSTOMIZE PAGE ========== -->
        <div id="screen-customize" class="screen">
            <div class="header">
                <button class="header-btn" onclick="navigateTo('home')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="header-title">Your Coffee</div>
                <button class="header-btn" onclick="openSaveModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                </button>
            </div>
            <div class="customize-container">
                <div class="dashboard">
                    <div class="dashboard-status"><span id="status-badge" class="status-badge">READY</span></div>
                    <div class="dashboard-metrics">
                        <div class="metric"><div class="metric-label">Temp</div><div><span id="live-temp" class="metric-value">--</span><span class="metric-unit">¬∞C</span></div></div>
                        <div class="metric"><div class="metric-label">Pressure</div><div><span id="live-pressure" class="metric-value">--</span><span class="metric-unit">Bar</span></div></div>
                        <div class="metric"><div class="metric-label">Volume</div><div><span id="live-volume" class="metric-value">--</span><span class="metric-unit">ml</span></div></div>
                    </div>
                </div>
                <div class="section-card">
                    <div class="section-header">‚òï Espresso</div>
                    <div class="param-row"><span class="param-label">Temperature</span><div class="param-controls"><button class="param-btn" onclick="adjustParam('brewTemp', -0.5)">‚àí</button><span class="param-value"><span id="val-brewTemp">93.0</span>¬∞C</span><button class="param-btn" onclick="adjustParam('brewTemp', 0.5)">+</button></div></div>
                    <div class="param-row"><span class="param-label">Pressure</span><div class="param-controls"><button class="param-btn" onclick="adjustParam('extractionPressure', -0.5)">‚àí</button><span class="param-value"><span id="val-extractionPressure">9.0</span> Bar</span><button class="param-btn" onclick="adjustParam('extractionPressure', 0.5)">+</button></div></div>
                    <div class="param-row"><span class="param-label">Pre-Infusion</span><div class="param-controls"><button class="param-btn" onclick="adjustParam('preInfusionTime', -1)">‚àí</button><span class="param-value"><span id="val-preInfusionTime">3</span>s</span><button class="param-btn" onclick="adjustParam('preInfusionTime', 1)">+</button></div></div>
                    <div class="param-row"><span class="param-label">Shot Volume</span><div class="param-controls"><button class="param-btn" onclick="adjustParam('shotVolume', -1)">‚àí</button><span class="param-value"><span id="val-shotVolume">36</span> ml</span><button class="param-btn" onclick="adjustParam('shotVolume', 1)">+</button></div></div>
                </div>
                <div class="section-card">
                    <div class="section-header">ü•õ Milk & Froth</div>
                    <div class="milk-selector">
                        <div class="milk-option active" data-milk="None" onclick="selectMilk('None')">None</div>
                        <div class="milk-option" data-milk="Dairy" onclick="selectMilk('Dairy')">Dairy</div>
                        <div class="milk-option" data-milk="Oat" onclick="selectMilk('Oat')">Oat</div>
                    </div>
                    <div id="milk-params" class="hidden">
                        <div class="param-row"><span class="param-label">Milk Volume</span><div class="param-controls"><button class="param-btn" onclick="adjustParam('milkVolume', -10)">‚àí</button><span class="param-value"><span id="val-milkVolume">0</span> ml</span><button class="param-btn" onclick="adjustParam('milkVolume', 10)">+</button></div></div>
                        <div class="param-row"><span class="param-label">Froth Level</span><div class="param-controls"><button class="param-btn" onclick="adjustParam('frothLevel', -10)">‚àí</button><span class="param-value"><span id="val-frothLevel">0</span>%</span><button class="param-btn" onclick="adjustParam('frothLevel', 10)">+</button></div></div>
                    </div>
                </div>
            </div>
            <div class="bottom-bar">
                <button class="action-btn secondary" onclick="navigateTo('home')">Back to Brewy</button>
                <button id="brew-btn" class="action-btn primary" onclick="startBrew()">START BREW</button>
            </div>
            <div id="brewing-overlay" class="brewing-overlay">
                <div class="brewing-icon">‚òï</div>
                <div id="brewing-phase" class="brewing-phase">Heating...</div>
                <div id="brewing-timer" class="brewing-timer">00:00</div>
                
                <!-- Live Parameters Display -->
                <div class="brewing-params-display">
                    <div class="brewing-param-row">
                        <span class="brewing-param-label">üå°Ô∏è Temp</span>
                        <span id="brew-live-temp" class="brewing-param-value">--¬∞C</span>
                    </div>
                    <div class="brewing-param-row">
                        <span class="brewing-param-label">üí® Pressure</span>
                        <span id="brew-live-pressure" class="brewing-param-value">-- Bar</span>
                    </div>
                    <div class="brewing-param-row">
                        <span class="brewing-param-label">üíß Volume</span>
                        <span id="brew-live-volume" class="brewing-param-value">-- ml</span>
                    </div>
                </div>
                
                <!-- Target Parameters (what we're aiming for) -->
                <div class="brewing-target-display">
                    <div class="brewing-target-title">Target Recipe</div>
                    <div id="brewing-target-params" class="brewing-target-params">
                        <!-- Filled dynamically -->
                    </div>
                </div>
                
                <button class="action-btn danger stop-brew-btn" onclick="stopBrew()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                    STOP BREW
                </button>
            </div>
        </div>

        <!-- ========== MACHINE PAGE ========== -->
        <div id="screen-machine" class="screen">
            <div class="header">
                <button class="header-btn" onclick="navigateTo('home')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="header-title">Machine</div>
                <div class="header-spacer"></div>
            </div>
            <div class="machine-container">
                <div class="machine-card">
                    <div class="machine-card-title">‚òï Connection Status</div>
                    <div class="connection-row">
                        <div id="machine-dot" class="connection-dot disconnected"></div>
                        <span id="machine-status-text" class="connection-text">Disconnected</span>
                    </div>
                    <div class="ip-input-group">
                        <input type="text" id="machine-ip" class="ip-input" placeholder="192.168.1.111" value="192.168.1.111">
                        <button class="connect-btn" onclick="connectToMachine()">Connect</button>
                    </div>
                </div>
                <div class="machine-card">
                    <div class="machine-card-title">üìä Live Readings</div>
                    <div class="dashboard-metrics">
                        <div class="metric"><div class="metric-label">Temp</div><div><span id="machine-temp" class="metric-value">--</span><span class="metric-unit">¬∞C</span></div></div>
                        <div class="metric"><div class="metric-label">Pressure</div><div><span id="machine-pressure" class="metric-value">--</span><span class="metric-unit">Bar</span></div></div>
                        <div class="metric"><div class="metric-label">Volume</div><div><span id="machine-volume" class="metric-value">--</span><span class="metric-unit">ml</span></div></div>
                    </div>
                </div>
                <div class="machine-card">
                    <div class="machine-card-title">üîß Machine Status</div>
                    <div style="text-align: center; padding: 20px;">
                        <span id="machine-phase-badge" class="status-badge">OFFLINE</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SAVED RECIPES PAGE ========== -->
        <div id="screen-recipes" class="screen">
            <div class="header">
                <button class="header-btn" onclick="navigateTo('home')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="header-title">My Recipes</div>
                <div class="header-spacer"></div>
            </div>
            <div id="recipes-list" class="recipes-container"></div>
        </div>

        <!-- NAV BAR -->
        <nav class="nav-bar">
            <button class="nav-item active" data-screen="home" onclick="navigateTo('home')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                <span>Brewy</span>
            </button>
            <button class="nav-item" data-screen="customize" onclick="navigateTo('customize')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                <span>Design</span>
            </button>
            <button class="nav-item" data-screen="machine" onclick="navigateTo('machine')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M17 2v5"/><path d="M7 2v5"/><circle cx="12" cy="14" r="3"/></svg>
                <span>Machine</span>
            </button>
            <button class="nav-item" data-screen="recipes" onclick="navigateTo('recipes')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                <span>Recipes</span>
            </button>
        </nav>

        <!-- QR CODE MODAL -->
        <div id="qr-modal" class="modal-overlay">
            <div class="modal-content" style="text-align: center;">
                <div class="modal-title">üì± Share App Clip</div>
                <p style="font-size: 13px; color: #666; margin-bottom: 16px;">Scan this QR code to open the app on any phone</p>
                <div id="qr-code-container" style="background: white; padding: 20px; border-radius: 12px; display: inline-block; margin-bottom: 16px;">
                    <canvas id="qr-canvas"></canvas>
                </div>
                <p style="font-size: 11px; color: #999; margin-bottom: 16px;">Works when hosted online (GitHub Pages, Netlify, etc.)</p>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeQRModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- SAVE MODAL -->
        <div id="save-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">Save Recipe</div>
                <input type="text" id="recipe-name-input" class="modal-input" placeholder="My Perfect Coffee">
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeSaveModal()">Cancel</button>
                    <button class="modal-btn save" onclick="saveCurrentRecipe()">Save</button>
                </div>
            </div>
        </div>

        <!-- TOAST -->
        <div id="toast" class="toast"></div>
    </div>
    <script>
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    const state = {
        // Machine
        machineIp: '192.168.1.111',
        isConnected: false,
        currentBrewTemp: 0,
        currentPressure: 0,
        currentShotVolume: 0,
        isBrewing: false,
        brewPhase: 'Ready',
        brewStartTime: null,
        pollingInterval: null,
        brewTimerInterval: null,
        
        // Recipe Parameters
        params: {
            brewTemp: 93.0,
            preInfusionTime: 3,
            extractionPressure: 9.0,
            shotVolume: 36,
            milkType: 'None',
            milkVolume: 0,
            frothLevel: 0
        },
        
        // Chat
        chatHistory: [],
        isAiTyping: false,
        pendingRecipe: null, // Recipe suggested by Brewy awaiting user action
        chatContext: { mode: 'welcome', selectedItem: null }, // Tracks current conversation context
        currentBrewRecipe: null, // The actual recipe being brewed (fixes display bug)
        
        // Saved Recipes (loaded from localStorage)
        savedRecipes: [],
        
        // Cafe Menu (predefined recipes)
        cafeMenu: [
            { name: 'House Espresso', params: { brewTemp: 93, extractionPressure: 9, preInfusionTime: 3, shotVolume: 36, milkType: 'None', milkVolume: 0, frothLevel: 0 }},
            { name: 'Oat Latte', params: { brewTemp: 92, extractionPressure: 9, preInfusionTime: 4, shotVolume: 36, milkType: 'Oat', milkVolume: 150, frothLevel: 40 }},
            { name: 'Cappuccino', params: { brewTemp: 93, extractionPressure: 9, preInfusionTime: 3, shotVolume: 30, milkType: 'Dairy', milkVolume: 100, frothLevel: 70 }},
            { name: 'Flat White', params: { brewTemp: 94, extractionPressure: 9, preInfusionTime: 2, shotVolume: 40, milkType: 'Dairy', milkVolume: 120, frothLevel: 20 }},
            { name: 'Americano', params: { brewTemp: 93, extractionPressure: 9, preInfusionTime: 3, shotVolume: 45, milkType: 'None', milkVolume: 0, frothLevel: 0 }}
        ],
        
        // AI Config
        apiKey: '' // Add your Gemini API key here
    };

    const paramLimits = {
        brewTemp: { min: 85, max: 105 },
        extractionPressure: { min: 2, max: 12 },
        preInfusionTime: { min: 0, max: 10 },
        shotVolume: { min: 10, max: 60 },
        milkVolume: { min: 0, max: 200 },
        frothLevel: { min: 0, max: 100 }
    };

    // ============================================
    // INITIALIZATION
    // ============================================
    function init() {
        loadSavedRecipes();
        updateAllParamDisplays();
        renderSavedRecipes();
        addBrewyMessage("Hey there! ‚òï I'm Brewy, ready to help craft your perfect cup. Tell me what you're in the mood for, or tap a quick option below!", false);
        fetchStatus();
    }

    // ============================================
    // LOCAL STORAGE - RECIPES
    // ============================================
    function loadSavedRecipes() {
        try {
            const saved = localStorage.getItem('myblend_recipes');
            state.savedRecipes = saved ? JSON.parse(saved) : [];
        } catch (e) {
            state.savedRecipes = [];
        }
    }

    function saveSavedRecipes() {
        localStorage.setItem('myblend_recipes', JSON.stringify(state.savedRecipes));
    }

    function saveRecipe(name, params) {
        const recipe = {
            id: Date.now(),
            name: name,
            params: { ...params },
            createdAt: new Date().toISOString()
        };
        state.savedRecipes.unshift(recipe);
        saveSavedRecipes();
        renderSavedRecipes();
        return recipe;
    }

    function deleteRecipe(id) {
        state.savedRecipes = state.savedRecipes.filter(r => r.id !== id);
        saveSavedRecipes();
        renderSavedRecipes();
    }

    function loadRecipeToParams(recipe) {
        Object.assign(state.params, recipe.params);
        updateAllParamDisplays();
        updateMilkUI();
    }

    // ============================================
    // MACHINE COMMUNICATION
    // ============================================
    function connectToMachine() {
        const ip = document.getElementById('machine-ip').value.trim();
        if (!ip) { showToast('Enter a valid IP address', 'error'); return; }
        state.machineIp = ip;
        showToast(`Connecting to ${ip}...`);
        fetchStatus();
    }

    async function fetchStatus() {
        try {
            const response = await fetch(`http://${state.machineIp}/status`, { method: 'GET', mode: 'cors', cache: 'no-cache' });
            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            
            const wasConnected = state.isConnected;
            const wasBrewing = state.isBrewing;
            
            state.isConnected = true;
            state.currentBrewTemp = parseFloat(data.brewTemp) || 0;
            state.currentPressure = parseFloat(data.pressure) || 0;
            state.currentShotVolume = parseFloat(data.shotVolume) || 0;
            state.isBrewing = data.isBrewing || false;
            
            // Update brew phase from firmware
            if (data.brewPhase) {
                state.brewPhase = data.brewPhase;
            } else if (data.status === "Heating...") {
                state.brewPhase = "Heating";
            } else if (data.status === "Dispensing Milk") {
                state.brewPhase = "Frothing";
            } else if (data.isBrewing) {
                state.brewPhase = (data.pressure < 4.0 && data.shotVolume < 5) ? "Pre-Infusion" : "Extraction";
            } else {
                state.brewPhase = "Ready";
            }
            
            // NEW: Detect brew completion
            if (wasBrewing && !data.isBrewing && data.brewComplete) {
                // Brew just finished - trigger completion flow
                const finalVolume = data.shotVolume || state.currentShotVolume;
                handleBrewComplete(finalVolume);
                return; // Don't continue normal updates
            }
            
            // Alternative detection: was brewing, now not, and has volume
            if (wasBrewing && !data.isBrewing && state.currentShotVolume > 5) {
                handleBrewComplete(state.currentShotVolume);
                return;
            }
            
            if (!wasConnected) {
                showToast('Connected to machine!', 'success');
            }
            
            updateMachineUI();
            updateBrewingLiveParams(); // Update brewing overlay if visible
            startPolling();
        } catch (error) {
            state.isConnected = false;
            state.brewPhase = 'Offline';
            updateMachineUI();
        }
    }

    async function sendCommand(endpoint, data = {}) {
        try {
            const response = await fetch(`http://${state.machineIp}/${endpoint}`, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
            });
            const result = await response.json();
            return { success: true, message: result.message || 'OK' };
        } catch (error) {
            return { success: false, message: `Failed: ${error.message}` };
        }
    }

    function startPolling() {
        if (state.pollingInterval) clearInterval(state.pollingInterval);
        state.pollingInterval = setInterval(fetchStatus, 500);
    }

    // ============================================
    // BREW CONTROL
    // ============================================
    async function startBrew() {
        if (!state.isConnected) { showToast('Connect to machine first', 'error'); return; }
        
        const recipe = {
            brewTemp: state.params.brewTemp,
            pressureProfile: { preInfusionTime: state.params.preInfusionTime, extractionPressure: state.params.extractionPressure },
            shotVolume: state.params.shotVolume,
            milkType: state.params.milkType,
            milkVolume: state.params.milkVolume,
            frothLevel: state.params.frothLevel
        };
        
        showToast('Starting brew...');
        const response = await sendCommand('brew/start', recipe);
        
        if (response.success) {
            state.isBrewing = true;
            state.brewStartTime = Date.now();
            showBrewingOverlay(true);
            startBrewTimer();
        } else {
            showToast(response.message, 'error');
        }
    }

    async function startBrewFromBrewy() {
        let recipeToUse;
        
        if (state.pendingRecipe) {
            // Copy pending recipe to use
            recipeToUse = { ...state.pendingRecipe };
            // Update state.params
            Object.assign(state.params, recipeToUse);
            updateAllParamDisplays();
            updateMilkUI();
            state.pendingRecipe = null;
        } else {
            recipeToUse = { ...state.params };
        }
        
        // CRITICAL: Store the recipe BEFORE navigating/brewing
        // This fixes the display bug where old params were shown
        state.currentBrewRecipe = recipeToUse;
        
        navigateTo('customize');
        setTimeout(() => startBrew(), 300);
    }

    async function stopBrew() {
        showToast('Stopping...');
        await sendCommand('brew/stop');
        state.isBrewing = false;
        showBrewingOverlay(false);
        stopBrewTimer();
    }

    function startBrewTimer() {
        if (state.brewTimerInterval) clearInterval(state.brewTimerInterval);
        state.brewTimerInterval = setInterval(() => {
            if (!state.brewStartTime) return;
            const elapsed = Math.floor((Date.now() - state.brewStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('brewing-timer').textContent = `${mins}:${secs}`;
            document.getElementById('brewing-phase').textContent = state.brewPhase;
        }, 100);
    }

    function stopBrewTimer() {
        if (state.brewTimerInterval) { clearInterval(state.brewTimerInterval); state.brewTimerInterval = null; }
    }

    function showBrewingOverlay(show) {
        document.getElementById('brewing-overlay').classList.toggle('active', show);
        
        if (show) {
            // Use the stored brew recipe (fixes parameter display bug)
            const targetParams = state.currentBrewRecipe || state.params;
            const targetEl = document.getElementById('brewing-target-params');
            if (targetEl) {
                let paramsHtml = `
                    <span>Temp <b>${targetParams.brewTemp}¬∞C</b></span>
                    <span>Pressure <b>${targetParams.extractionPressure} Bar</b></span>
                    <span>Pre-infuse <b>${targetParams.preInfusionTime}s</b></span>
                    <span>Volume <b>${targetParams.shotVolume}ml</b></span>
                `;
                if (targetParams.milkType !== 'None') {
                    paramsHtml += `<span>Milk <b>${targetParams.milkType}</b></span>`;
                    paramsHtml += `<span>Froth <b>${targetParams.frothLevel}%</b></span>`;
                }
                targetEl.innerHTML = paramsHtml;
            }
            
            // Start live parameter updates
            updateBrewingLiveParams();
        }
    }
    
    function updateBrewingLiveParams() {
        const tempEl = document.getElementById('brew-live-temp');
        const pressureEl = document.getElementById('brew-live-pressure');
        const volumeEl = document.getElementById('brew-live-volume');
        
        // Temperature always shows
        if (tempEl) tempEl.textContent = state.isConnected ? `${state.currentBrewTemp.toFixed(1)}¬∞C` : '--¬∞C';
        
        // Pressure and volume only meaningful during active brewing
        // Filter out noise readings when not brewing
        if (pressureEl) {
            const showPressure = state.isBrewing && state.currentPressure > 0.3;
            pressureEl.textContent = showPressure ? `${state.currentPressure.toFixed(1)} Bar` : '0.0 Bar';
        }
        if (volumeEl) {
            volumeEl.textContent = state.isBrewing ? `${state.currentShotVolume.toFixed(0)} ml` : '0 ml';
        }
    }
    
    // NEW: Handle brew completion with auto-return
    function handleBrewComplete(finalVolume) {
        // Stop timer
        stopBrewTimer();
        state.isBrewing = false;
        
        // Get drink name for display
        const drinkName = state.chatContext?.selectedItem || state.currentBrewRecipe?.recipeName || 'custom brew';
        
        // Update overlay to show completion
        const overlay = document.getElementById('brewing-overlay');
        overlay.innerHTML = `
            <div class="brew-complete">
                <div class="brew-complete-icon">‚òï</div>
                <div class="brew-complete-title">Your Coffee is Ready!</div>
                <div class="brew-complete-volume">${finalVolume.toFixed(0)}ml of perfection</div>
                <div class="brew-complete-message">Enjoy your ${drinkName}!</div>
            </div>
        `;
        overlay.classList.add('complete');
        
        // Auto-return to home after 3 seconds
        setTimeout(() => {
            showBrewingOverlay(false);
            overlay.classList.remove('complete');
            // Restore original overlay content
            restoreBrewingOverlay();
            resetToWelcome();
            showToast('Come back anytime! ‚òï', 'success');
            // Clear the stored recipe
            state.currentBrewRecipe = null;
        }, 3000);
    }
    
    function restoreBrewingOverlay() {
        const overlay = document.getElementById('brewing-overlay');
        overlay.innerHTML = `
            <div class="brewing-icon">‚òï</div>
            <div id="brewing-phase" class="brewing-phase">Heating...</div>
            <div id="brewing-timer" class="brewing-timer">00:00</div>
            
            <div class="brewing-params-display">
                <div class="brewing-param-row">
                    <span class="brewing-param-label">üå°Ô∏è Temp</span>
                    <span id="brew-live-temp" class="brewing-param-value">--¬∞C</span>
                </div>
                <div class="brewing-param-row">
                    <span class="brewing-param-label">üí® Pressure</span>
                    <span id="brew-live-pressure" class="brewing-param-value">-- Bar</span>
                </div>
                <div class="brewing-param-row">
                    <span class="brewing-param-label">üíß Volume</span>
                    <span id="brew-live-volume" class="brewing-param-value">-- ml</span>
                </div>
            </div>
            
            <div class="brewing-target-display">
                <div class="brewing-target-title">Target Recipe</div>
                <div id="brewing-target-params" class="brewing-target-params"></div>
            </div>
            
            <button class="action-btn danger stop-brew-btn" onclick="stopBrew()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                STOP BREW
            </button>
        `;
    }

    // ============================================
    // PARAMETER CONTROLS
    // ============================================
    function adjustParam(param, delta) {
        const limits = paramLimits[param];
        let val = state.params[param] + delta;
        val = Math.max(limits.min, Math.min(limits.max, val));
        if (param === 'brewTemp' || param === 'extractionPressure') val = Math.round(val * 10) / 10;
        else val = Math.round(val);
        state.params[param] = val;
        updateParamDisplay(param);
    }

    function updateParamDisplay(param) {
        const el = document.getElementById(`val-${param}`);
        if (el) {
            const val = state.params[param];
            el.textContent = (param === 'brewTemp' || param === 'extractionPressure') ? val.toFixed(1) : val;
        }
    }

    function updateAllParamDisplays() {
        Object.keys(state.params).forEach(p => { if (p !== 'milkType') updateParamDisplay(p); });
    }

    function selectMilk(type) {
        state.params.milkType = type;
        document.querySelectorAll('.milk-option').forEach(o => o.classList.toggle('active', o.dataset.milk === type));
        updateMilkUI();
    }

    function updateMilkUI() {
        const milkParams = document.getElementById('milk-params');
        if (state.params.milkType === 'None') {
            milkParams.classList.add('hidden');
            state.params.milkVolume = 0;
            state.params.frothLevel = 0;
        } else {
            milkParams.classList.remove('hidden');
            if (state.params.milkVolume === 0) state.params.milkVolume = 100;
            if (state.params.frothLevel === 0) state.params.frothLevel = 50;
        }
        document.querySelectorAll('.milk-option').forEach(o => o.classList.toggle('active', o.dataset.milk === state.params.milkType));
        updateParamDisplay('milkVolume');
        updateParamDisplay('frothLevel');
    }

    // ============================================
    // UI UPDATES
    // ============================================
    function updateMachineUI() {
        const dot = document.getElementById('machine-dot');
        const text = document.getElementById('machine-status-text');
        const badge = document.getElementById('machine-phase-badge');
        
        if (dot) {
            dot.classList.toggle('connected', state.isConnected);
            dot.classList.toggle('disconnected', !state.isConnected);
        }
        if (text) {
            text.textContent = state.isConnected ? 'Connected' : 'Disconnected';
        }
        
        if (badge) {
            badge.textContent = state.brewPhase.toUpperCase();
            badge.className = 'status-badge';
            if (state.brewPhase === 'Heating') badge.classList.add('heating');
            else if (state.brewPhase === 'Pre-Infusion') badge.classList.add('pre-infusion');
            else if (state.brewPhase === 'Extraction') badge.classList.add('extraction');
            else if (state.brewPhase === 'Frothing') badge.classList.add('frothing');
            else if (state.brewPhase === 'Offline') badge.classList.add('offline');
        }
        
        // Update all live readings
        ['machine', 'live'].forEach(prefix => {
            const t = document.getElementById(`${prefix}-temp`);
            const p = document.getElementById(`${prefix}-pressure`);
            const v = document.getElementById(`${prefix}-volume`);
            if (t) t.textContent = state.isConnected ? state.currentBrewTemp.toFixed(1) : '--';
            if (p) p.textContent = state.isConnected ? state.currentPressure.toFixed(1) : '--';
            if (v) v.textContent = state.isConnected ? state.currentShotVolume.toFixed(1) : '--';
        });
        
        const statusBadge = document.getElementById('status-badge');
        if (statusBadge) {
            statusBadge.textContent = state.brewPhase.toUpperCase();
            statusBadge.className = 'status-badge';
            if (state.isBrewing) statusBadge.classList.add('brewing');
        }
    }

    function renderSavedRecipes() {
        const container = document.getElementById('recipes-list');
        if (state.savedRecipes.length === 0) {
            container.innerHTML = `<div class="recipes-empty"><div class="recipes-empty-icon">üìñ</div><div>No saved recipes yet</div><div style="margin-top:8px;font-size:13px;">Ask Brewy to craft something, then save it!</div></div>`;
            return;
        }
        container.innerHTML = state.savedRecipes.map(r => `
            <div class="saved-recipe-card">
                <div class="saved-recipe-name">${escapeHtml(r.name)}</div>
                <div class="saved-recipe-params">
                    <span class="saved-recipe-param">${r.params.brewTemp}¬∞C</span>
                    <span class="saved-recipe-param">${r.params.extractionPressure} Bar</span>
                    <span class="saved-recipe-param">${r.params.shotVolume}ml</span>
                    ${r.params.milkType !== 'None' ? `<span class="saved-recipe-param">${r.params.milkType} ${r.params.milkVolume}ml</span>` : ''}
                </div>
                <div class="saved-recipe-actions">
                    <button class="saved-recipe-btn brew" onclick="brewSavedRecipe(${r.id})">Brew</button>
                    <button class="saved-recipe-btn edit" onclick="editSavedRecipe(${r.id})">Edit</button>
                    <button class="saved-recipe-btn delete" onclick="confirmDeleteRecipe(${r.id})">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function brewSavedRecipe(id) {
        const recipe = state.savedRecipes.find(r => r.id === id);
        if (recipe) {
            loadRecipeToParams(recipe);
            navigateTo('customize');
            showToast(`Loaded "${recipe.name}"`);
        }
    }

    function editSavedRecipe(id) {
        const recipe = state.savedRecipes.find(r => r.id === id);
        if (recipe) {
            loadRecipeToParams(recipe);
            navigateTo('customize');
        }
    }

    function confirmDeleteRecipe(id) {
        const recipe = state.savedRecipes.find(r => r.id === id);
        if (recipe && confirm(`Delete "${recipe.name}"?`)) {
            deleteRecipe(id);
            showToast('Recipe deleted');
        }
    }

    // ============================================
    // NAVIGATION
    // ============================================
    function navigateTo(screenName) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${screenName}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.screen === screenName));
        
        // Reset to welcome view when navigating to home
        if (screenName === 'home') {
            resetToWelcome();
        }
    }

    // ============================================
    // MODALS
    // ============================================
    function openSaveModal() {
        document.getElementById('save-modal').classList.add('active');
        document.getElementById('recipe-name-input').value = '';
        document.getElementById('recipe-name-input').focus();
    }

    function closeSaveModal() {
        document.getElementById('save-modal').classList.remove('active');
    }

    function openQRModal() {
        document.getElementById('qr-modal').classList.add('active');
        generateQRCode();
    }

    function closeQRModal() {
        document.getElementById('qr-modal').classList.remove('active');
    }

    function generateQRCode() {
        const canvas = document.getElementById('qr-canvas');
        const ctx = canvas.getContext('2d');
        const url = window.location.href;
        
        // Simple QR code generation using a library-free approach
        // For production, use a proper QR library, but this creates a placeholder
        const size = 200;
        canvas.width = size;
        canvas.height = size;
        
        // Draw QR code using QR Code API (works when online)
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() {
            ctx.drawImage(img, 0, 0, size, size);
        };
        img.onerror = function() {
            // Fallback: show URL as text if API fails
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#333';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Host this file online', size/2, size/2 - 20);
            ctx.fillText('to generate QR code', size/2, size/2);
            ctx.font = '10px sans-serif';
            ctx.fillStyle = '#666';
            ctx.fillText('(GitHub Pages, Netlify)', size/2, size/2 + 25);
        };
        // Use Google Charts QR API
        img.src = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encodeURIComponent(url)}&choe=UTF-8`;
    }

    function saveCurrentRecipe() {
        const name = document.getElementById('recipe-name-input').value.trim() || 'My Coffee';
        saveRecipe(name, state.params);
        closeSaveModal();
        showToast(`Saved "${name}"`, 'success');
    }

    // ============================================
    // UTILITIES
    // ============================================
    function showToast(msg, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast' + (type ? ` ${type}` : '');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }
    // ============================================
    // BREWY CHAT SYSTEM
    // ============================================
    
    function addBrewyMessage(text, showTyping = true) {
        const container = document.getElementById('chat-messages');
        const brewyIcon = '<img src="data:image/png;base64,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" class="mini-brewy-icon" alt="">';
        
        if (showTyping) {
            const typingId = 'typing-' + Date.now();
            container.innerHTML += `<div id="${typingId}" class="message brewy"><div class="message-sender">${brewyIcon} Brewy</div><div class="message-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div></div>`;
            container.scrollTop = container.scrollHeight;
            
            setTimeout(() => {
                const typingEl = document.getElementById(typingId);
                if (typingEl) typingEl.remove();
                appendBrewyMessage(text);
            }, 800 + Math.random() * 500);
        } else {
            appendBrewyMessage(text);
        }
    }

    function appendBrewyMessage(text) {
        const container = document.getElementById('chat-messages');
        const brewyIcon = '<img src="data:image/png;base64,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" class="mini-brewy-icon" alt="">';
        const msgHtml = `<div class="message brewy"><div class="message-sender">${brewyIcon} Brewy</div><div class="message-bubble">${text}</div></div>`;
        container.innerHTML += msgHtml;
        container.scrollTop = container.scrollHeight;
        state.chatHistory.push({ role: 'assistant', content: text });
    }

    function addUserMessage(text) {
        const container = document.getElementById('chat-messages');
        container.innerHTML = '';
        container.innerHTML += `<div class="message user"><div class="message-sender">You</div><div class="message-bubble">${escapeHtml(text)}</div></div>`;
        container.scrollTop = container.scrollHeight;
        state.chatHistory.push({ role: 'user', content: text });
    }

    function addRecipeCard(params, recipeName = 'Your Custom Brew') {
        const container = document.getElementById('chat-messages');
        const milkInfo = params.milkType !== 'None' ? `<div class="recipe-param"><div class="recipe-param-label">Milk</div><div class="recipe-param-value">${params.milkType} ${params.milkVolume}ml</div></div><div class="recipe-param"><div class="recipe-param-label">Froth</div><div class="recipe-param-value">${params.frothLevel}%</div></div>` : '';
        
        const cardHtml = `
            <div class="message brewy" style="max-width:95%;">
                <div class="recipe-card">
                    <div class="recipe-card-title">‚òï ${escapeHtml(recipeName)}</div>
                    <div class="recipe-params">
                        <div class="recipe-param"><div class="recipe-param-label">Temp</div><div class="recipe-param-value">${params.brewTemp}¬∞C</div></div>
                        <div class="recipe-param"><div class="recipe-param-label">Pressure</div><div class="recipe-param-value">${params.extractionPressure} Bar</div></div>
                        <div class="recipe-param"><div class="recipe-param-label">Pre-Infusion</div><div class="recipe-param-value">${params.preInfusionTime}s</div></div>
                        <div class="recipe-param"><div class="recipe-param-label">Volume</div><div class="recipe-param-value">${params.shotVolume}ml</div></div>
                        ${milkInfo}
                    </div>
                    <div class="adjustment-options">
                        <button class="adjust-btn stronger" onclick="adjustRecipe('stronger')">üí™ Stronger</button>
                        <button class="adjust-btn smoother" onclick="adjustRecipe('smoother')">üåä Smoother</button>
                        <button class="adjust-btn brighter" onclick="adjustRecipe('brighter')">‚òÄÔ∏è Brighter</button>
                    </div>
                    <div class="recipe-actions">
                        <button class="recipe-btn secondary" onclick="modifyPendingRecipe()">Modify</button>
                        <button class="recipe-btn primary" onclick="proceedWithRecipe()">Proceed ‚òï</button>
                    </div>
                </div>
            </div>`;
        container.innerHTML += cardHtml;
        container.scrollTop = container.scrollHeight;
        
        // Store pending recipe
        state.pendingRecipe = { ...params };
    }

    function proceedWithRecipe() {
        if (!state.isConnected) {
            clearChatAndShow("Oops! We need to connect to the machine first. Head to the Machine tab to connect! ‚öôÔ∏è");
            return;
        }
        clearChatAndShow("Perfect! Let's brew this beauty! ‚òï‚ú® Sending to the machine now...");
        setTimeout(() => startBrewFromBrewy(), 1000);
    }

    function modifyPendingRecipe() {
        if (state.pendingRecipe) {
            Object.assign(state.params, state.pendingRecipe);
            updateAllParamDisplays();
            updateMilkUI();
        }
        navigateTo('customize');
    }

    // ============================================
    // NEW MENU FLOW
    // ============================================
    function startMenuFlow() {
        // Hide welcome view, show chat view
        document.getElementById('welcome-view').classList.add('hidden');
        document.getElementById('chat-view').classList.remove('hidden');
        
        // Store context
        state.chatContext = { mode: 'menu', selectedItem: null };
        
        // Clear and show menu
        showMenuOptions();
    }

    function backToMenu() {
        state.chatContext = { mode: 'menu', selectedItem: null };
        state.pendingRecipe = null;
        showMenuOptions();
    }

    function resetToWelcome() {
        document.getElementById('welcome-view').classList.remove('hidden');
        document.getElementById('chat-view').classList.add('hidden');
        document.getElementById('chat-messages').innerHTML = '';
        state.chatContext = { mode: 'welcome', selectedItem: null };
        state.pendingRecipe = null;
    }

    function clearChatAndShow(message) {
        const container = document.getElementById('chat-messages');
        const brewyIcon = '<img src="data:image/png;base64,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" class="mini-brewy-icon" alt="">';
        container.innerHTML = `<div class="message brewy"><div class="message-sender">${brewyIcon} Brewy</div><div class="message-bubble">${message}</div></div>`;
    }

    function adjustRecipe(adjustment) {
        if (!state.pendingRecipe) return;
        
        const container = document.getElementById('chat-messages');
        let newParams = { ...state.pendingRecipe };
        let adjustmentName = '';
        
        switch(adjustment) {
            case 'stronger':
                adjustmentName = 'Stronger';
                newParams.extractionPressure = clamp(newParams.extractionPressure + 0.5, 2, 12);
                newParams.brewTemp = clamp(newParams.brewTemp + 1, 85, 105);
                newParams.preInfusionTime = clamp(newParams.preInfusionTime + 1, 0, 10);
                if (newParams.shotVolume > 25) {
                    newParams.shotVolume = clamp(newParams.shotVolume - 4, 15, 60);
                }
                break;
            case 'smoother':
                adjustmentName = 'Smoother';
                newParams.extractionPressure = clamp(newParams.extractionPressure - 0.5, 6, 12);
                newParams.brewTemp = clamp(newParams.brewTemp - 1, 85, 105);
                newParams.preInfusionTime = clamp(newParams.preInfusionTime + 2, 0, 10);
                newParams.shotVolume = clamp(newParams.shotVolume + 4, 20, 60);
                break;
            case 'brighter':
                adjustmentName = 'Brighter';
                newParams.brewTemp = clamp(newParams.brewTemp - 2, 85, 105);
                newParams.extractionPressure = clamp(newParams.extractionPressure - 0.5, 6, 12);
                newParams.preInfusionTime = clamp(newParams.preInfusionTime - 1, 0, 10);
                newParams.shotVolume = clamp(newParams.shotVolume - 2, 15, 60);
                break;
        }
        
        // Update pending recipe
        state.pendingRecipe = newParams;
        
        // Clear chat and show new recipe
        const brewyIcon = '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAGKADAAQAAAABAAAAGAAAAADiNXWtAAAFSklEQVRIDZVWC0yURxD+/js4OLiT1+lBoRZQVHxgxReoKZVWrKk2aX1bW1NNrcZaqbZpjbGJSU2MaTVGWyPVPlKjiVo1CpamEqqkKDUqaRVRAUHlAI+HHIfc67/p7B53AkKabvLvzu5+OzM7883eKV6vl/BfjQh+kKIo/aKJvJAg3lYUTQCjDGyAD8AH7KvUywZ7mum7L7R7vao09IwBr8cNTbCulwKb7Qkaaqqg0WoRm5QMo0Ef8NAvPKirh73jEe9FISExUS6z8+hloLcnrQyKxi95e5EyOhkpk6cjJCQENRU3oAuJwtBhw6WSLjfwx5GdMBndsOlMCFfbYWt1YPwbn8IcE9odAwn1dWUn8uBuqeCJHsUFhZi/ZDrSZszClbxtOPzxUlz+eRcK8wsCJ66eP4k5K96CQR+JcdpmUNtj5MydjBu/H4THw5kTOZCfRyXR1kWDjm39UMoPa+/RsrR4iuT0jedvXihoFI/rzaB6a5vElJzaRxd2LKJV0xMFD2hGBOT69TNfk81mpx4h4sTJ7Hcwzig9zM0ei2+Kb2LHnARMHBGPMUlm5FfaYbb8hfsON9b85sDdO7egrTgKqzMUBzZuwaisCXh1dgaeRKQjY97K7hww9fyscDVegS52MsovXcS0aVn4KF2HEWEu5F8BlmQCN7rCYK95ArIC7xcdR2r2AlSc+QIjJ2aio6oUCDfjQlkTslduw6BQ1upVPfJKXdUF1F62W8qie+/FeEriKx9IB536Mleulx/cQrN5TbTrP+6gA69HU22bh86fOkb1dqKKuk6qq7fJfdGJ0HOIVJKhUe2AVtBPK8OTyrdKiwVeMQGr/yHMnfUaFi57G0aV0MTcGBRtRuvB5Vh/rkniUbMfSH6X5XA5V1UVGo1GsEiBKopZa0DlpRLYrRa4PCpqGRZr1kOUW2VlLRrcOtwtOY2RBjsuXLuD7/P2QNvVAktbJ0pLSlj5O3B1dIDt8xV9yoUlWaoaUebcdr08E03XitDW0gwHz7WKE2s2bcCIP7/F6imRSHtcjMq967BipBtFnyzF7ElTsXvndjTWVTPawCQhPiM0PX0qAjQNBI6F8ovFxDyi7RmhdHxREhUuHkybUkDzx2UQR42OTgHVrIih76bpKMEUTa1N9wPH+Rnx0b6b/j1MAW5HJ1tXERmfJCN57G8Hgl4YhSrDWKQYgIXJTfgqW49HmUvwkz4Hl/Xj8flnGxAV7kLtvTrhOpNGlWOgCxQaW+6uNenNLPaUQbRnbQ7PS+nQ4uG0ZkosrcyaQPGxZpqYNoaGPWemuWlD6WrBIS5gphE3D5dvQKd4qXtOJMDtlMB9uasoodvI8Bgj/Xr2iFwX3drlCyhG53NAOOFvPXX55V4hEtdSNMFiQPOjBiyequeCykdzSwdKThfgzq3r+GHnVuw/fAItLsBisQrtEj9Q18uAys+rRiNpgMIj59DYzlwyGbFlErB5URzun9yMdGM1Kz0LKl0PY0SU1Ot2OuV1+jPS4y3ybSvCIy6QhntVOL5/OwxGL4bonJiQasYQUwSC4xJx+3YD6q0epOZsRJzZCFlUWva1v8v4Y+Uf/fH0j2yWwoKe909l4sWapfHpkyA2/ef7jr1C5L+iu7OdRQc+SFUwmKXcN4dyz8XotiCOpSzxxQ6Can8IONuYKGx3gN/qZ0PEQFf7Q+i8TSg7X4Tym9V4KT0RoYodwUEhaPWG44G1C2FBwMyZmVCDh0AxjWZy8BvWT8KfMSA88aWZ3fwfjaPUL5r96NMYKP+kMJ7jKWmocNL9v9dCkfiEEz7GsTRAeITmfwESnkwAlJNz8AAAAABJRU5ErkJggg==" class="mini-brewy-icon" alt="">';
        container.innerHTML = `<div class="message brewy"><div class="message-sender">${brewyIcon} Brewy</div><div class="message-bubble">Here's a ${adjustmentName.toLowerCase()} version for you:</div></div>`;
        
        // Add the new recipe card
        setTimeout(() => {
            addRecipeCard(newParams, `${adjustmentName} Blend`);
        }, 300);
    }

    // ============================================
    // CHAT INPUT HANDLING
    // ============================================
    function handleChatKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    }

    function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text || state.isAiTyping) return;
        
        input.value = '';
        addUserMessage(text);
        processUserMessage(text);
    }

    function sendQuickAction(text) {
        addUserMessage(text);
        processUserMessage(text);
    }

    // ============================================
    // MESSAGE PROCESSING
    // ============================================
    async function processUserMessage(text) {
        const lowerText = text.toLowerCase();
        state.isAiTyping = true;
        document.getElementById('chat-send-btn').disabled = true;

        try {
            // Check for menu request
            if (lowerText.includes('menu') || lowerText.includes('what do you have') || lowerText.includes('options')) {
                showMenuOptions();
                return;
            }

            // Check for specific menu item
            const menuMatch = state.cafeMenu.find(item => lowerText.includes(item.name.toLowerCase()));
            if (menuMatch) {
                handleMenuSelection(menuMatch);
                return;
            }

            // Check for modification intent
            if (lowerText.includes('modify') || lowerText.includes('change') || lowerText.includes('adjust')) {
                if (state.pendingRecipe) {
                    addBrewyMessage("Sure! What would you like to change? You can say things like 'make it hotter' or 'less milk'. Or head to the Design page to adjust manually! üéõÔ∏è");
                } else {
                    addBrewyMessage("Want to tweak a recipe? Load one from your saved recipes or tell me what kind of coffee you're craving! ‚òï");
                }
                return;
            }

            // Check for affirmative response to pending recipe
            if (state.pendingRecipe && (lowerText.includes('yes') || lowerText.includes('ok') || lowerText.includes('sure') || lowerText.includes('proceed') || lowerText.includes('brew') || lowerText.includes('go ahead') || lowerText.includes('let\'s do it'))) {
                proceedWithRecipe();
                return;
            }

            // Process with AI for custom requests
            await processWithAI(text);

        } finally {
            state.isAiTyping = false;
            document.getElementById('chat-send-btn').disabled = false;
        }
    }

    function showMenuOptions() {
        const container = document.getElementById('chat-messages');
        const brewyIcon = '<img src="data:image/png;base64,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" class="mini-brewy-icon" alt="">';
        
        let menuHtml = `<div class="message brewy"><div class="message-sender">${brewyIcon} Brewy</div><div class="message-bubble">What would you like today? Pick a drink to get started! ‚òï<br><br>`;
        state.cafeMenu.forEach(item => {
            menuHtml += `<button class="quick-action-btn" style="margin:4px;" onclick="selectMenuItem('${item.name}')">${item.name}</button>`;
        });
        menuHtml += `</div></div>`;
        
        container.innerHTML = menuHtml;
    }

    function selectMenuItem(itemName) {
        const menuItem = state.cafeMenu.find(item => item.name === itemName);
        if (menuItem) {
            handleMenuSelection(menuItem);
        }
    }

    function handleMenuSelection(menuItem) {
        const container = document.getElementById('chat-messages');
        const brewyIcon = '<img src="data:image/png;base64,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" class="mini-brewy-icon" alt="">';
        
        // Set context for the chat - user has selected a menu item
        state.chatContext = { mode: 'item_selected', selectedItem: menuItem.name };
        
        // Update placeholder to reflect context
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.placeholder = `Customize your ${menuItem.name}... (e.g., 'make it stronger' or 'extra hot')`;
        }
        
        // Clear chat and show selection
        container.innerHTML = `<div class="message brewy"><div class="message-sender">${brewyIcon} Brewy</div><div class="message-bubble">Great choice! ${menuItem.name} coming right up ‚òï</div></div>`;
        
        setTimeout(() => {
            addRecipeCard(menuItem.params, menuItem.name);
        }, 400);
    }

    // ============================================
    // AI PROCESSING
    // ============================================
    async function processWithAI(userText) {
        // If no API key, use rule-based fallback
        if (!state.apiKey) {
            const params = generateParamsFromRules(userText);
            const container = document.getElementById('chat-messages');
            container.innerHTML += `<div class="message brewy"><div class="message-sender"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAGKADAAQAAAABAAAAGAAAAADiNXWtAAAFSklEQVRIDZVWC0yURxD+/js4OLiT1+lBoRZQVHxgxReoKZVWrKk2aX1bW1NNrcZaqbZpjbGJSU2MaTVGWyPVPlKjiVo1CpamEqqkKDUqaRVRAUHlAI+HHIfc67/p7B53AkKabvLvzu5+OzM7883eKV6vl/BfjQh+kKIo/aKJvJAg3lYUTQCjDGyAD8AH7KvUywZ7mum7L7R7vao09IwBr8cNTbCulwKb7Qkaaqqg0WoRm5QMo0Ef8NAvPKirh73jEe9FISExUS6z8+hloLcnrQyKxi95e5EyOhkpk6cjJCQENRU3oAuJwtBhw6WSLjfwx5GdMBndsOlMCFfbYWt1YPwbn8IcE9odAwn1dWUn8uBuqeCJHsUFhZi/ZDrSZszClbxtOPzxUlz+eRcK8wsCJ66eP4k5K96CQR+JcdpmUNtj5MydjBu/H4THw5kTOZCfRyXR1kWDjm39UMoPa+/RsrR4iuT0jedvXihoFI/rzaB6a5vElJzaRxd2LKJV0xMFD2hGBOT69TNfk81mpx4h4sTJ7Hcwzig9zM0ei2+Kb2LHnARMHBGPMUlm5FfaYbb8hfsON9b85sDdO7egrTgKqzMUBzZuwaisCXh1dgaeRKQjY97K7hww9fyscDVegS52MsovXcS0aVn4KF2HEWEu5F8BlmQCN7rCYK95ArIC7xcdR2r2AlSc+QIjJ2aio6oUCDfjQlkTslduw6BQ1upVPfJKXdUF1F62W8qie+/FeEriKx9IB536Mleulx/cQrN5TbTrP+6gA69HU22bh86fOkb1dqKKuk6qq7fJfdGJ0HOIVJKhUe2AVtBPK8OTyrdKiwVeMQGr/yHMnfUaFi57G0aV0MTcGBRtRuvB5Vh/rkniUbMfSH6X5XA5V1UVGo1GsEiBKopZa0DlpRLYrRa4PCpqGRZr1kOUW2VlLRrcOtwtOY2RBjsuXLuD7/P2QNvVAktbJ0pLSlj5O3B1dIDt8xV9yoUlWaoaUebcdr08E03XitDW0gwHz7WKE2s2bcCIP7/F6imRSHtcjMq967BipBtFnyzF7ElTsXvndjTWVTPawCQhPiM0PX0qAjQNBI6F8ovFxDyi7RmhdHxREhUuHkybUkDzx2UQR42OTgHVrIih76bpKMEUTa1N9wPH+Rnx0b6b/j1MAW5HJ1tXERmfJCN57G8Hgl4YhSrDWKQYgIXJTfgqW49HmUvwkz4Hl/Xj8flnGxAV7kLtvTrhOpNGlWOgCxQaW+6uNenNLPaUQbRnbQ7PS+nQ4uG0ZkosrcyaQPGxZpqYNoaGPWemuWlD6WrBIS5gphE3D5dvQKd4qXtOJMDtlMB9uasoodvI8Bgj/Xr2iFwX3drlCyhG53NAOOFvPXX55V4hEtdSNMFiQPOjBiyequeCykdzSwdKThfgzq3r+GHnVuw/fAItLsBisQrtEj9Q18uAys+rRiNpgMIj59DYzlwyGbFlErB5URzun9yMdGM1Kz0LKl0PY0SU1Ot2OuV1+jPS4y3ybSvCIy6QhntVOL5/OwxGL4bonJiQasYQUwSC4xJx+3YD6q0epOZsRJzZCFlUWva1v8v4Y+Uf/fH0j2yWwoKe909l4sWapfHpkyA2/ef7jr1C5L+iu7OdRQc+SFUwmKXcN4dyz8XotiCOpSzxxQ6Can8IONuYKGx3gN/qZ0PEQFf7Q+i8TSg7X4Tym9V4KT0RoYodwUEhaPWG44G1C2FBwMyZmVCDh0AxjWZy8BvWT8KfMSA88aWZ3fwfjaPUL5r96NMYKP+kMJ7jKWmocNL9v9dCkfiEEz7GsTRAeITmfwESnkwAlJNz8AAAAABJRU5ErkJggg==" class="mini-brewy-icon" alt=""> Brewy</div><div class="message-bubble">Based on what you're looking for, here's my recommendation:</div></div>`;
            setTimeout(() => {
                addRecipeCard(params, 'Brewy\'s Pick');
                setTimeout(() => {
                    container.innerHTML += `<div class="message brewy"><div class="message-sender"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAGKADAAQAAAABAAAAGAAAAADiNXWtAAAFSklEQVRIDZVWC0yURxD+/js4OLiT1+lBoRZQVHxgxReoKZVWrKk2aX1bW1NNrcZaqbZpjbGJSU2MaTVGWyPVPlKjiVo1CpamEqqkKDUqaRVRAUHlAI+HHIfc67/p7B53AkKabvLvzu5+OzM7883eKV6vl/BfjQh+kKIo/aKJvJAg3lYUTQCjDGyAD8AH7KvUywZ7mum7L7R7vao09IwBr8cNTbCulwKb7Qkaaqqg0WoRm5QMo0Ef8NAvPKirh73jEe9FISExUS6z8+hloLcnrQyKxi95e5EyOhkpk6cjJCQENRU3oAuJwtBhw6WSLjfwx5GdMBndsOlMCFfbYWt1YPwbn8IcE9odAwn1dWUn8uBuqeCJHsUFhZi/ZDrSZszClbxtOPzxUlz+eRcK8wsCJ66eP4k5K96CQR+JcdpmUNtj5MydjBu/H4THw5kTOZCfRyXR1kWDjm39UMoPa+/RsrR4iuT0jedvXihoFI/rzaB6a5vElJzaRxd2LKJV0xMFD2hGBOT69TNfk81mpx4h4sTJ7Hcwzig9zM0ei2+Kb2LHnARMHBGPMUlm5FfaYbb8hfsON9b85sDdO7egrTgKqzMUBzZuwaisCXh1dgaeRKQjY97K7hww9fyscDVegS52MsovXcS0aVn4KF2HEWEu5F8BlmQCN7rCYK95ArIC7xcdR2r2AlSc+QIjJ2aio6oUCDfjQlkTslduw6BQ1upVPfJKXdUF1F62W8qie+/FeEriKx9IB536Mleulx/cQrN5TbTrP+6gA69HU22bh86fOkb1dqKKuk6qq7fJfdGJ0HOIVJKhUe2AVtBPK8OTyrdKiwVeMQGr/yHMnfUaFi57G0aV0MTcGBRtRuvB5Vh/rkniUbMfSH6X5XA5V1UVGo1GsEiBKopZa0DlpRLYrRa4PCpqGRZr1kOUW2VlLRrcOtwtOY2RBjsuXLuD7/P2QNvVAktbJ0pLSlj5O3B1dIDt8xV9yoUlWaoaUebcdr08E03XitDW0gwHz7WKE2s2bcCIP7/F6imRSHtcjMq967BipBtFnyzF7ElTsXvndjTWVTPawCQhPiM0PX0qAjQNBI6F8ovFxDyi7RmhdHxREhUuHkybUkDzx2UQR42OTgHVrIih76bpKMEUTa1N9wPH+Rnx0b6b/j1MAW5HJ1tXERmfJCN57G8Hgl4YhSrDWKQYgIXJTfgqW49HmUvwkz4Hl/Xj8flnGxAV7kLtvTrhOpNGlWOgCxQaW+6uNenNLPaUQbRnbQ7PS+nQ4uG0ZkosrcyaQPGxZpqYNoaGPWemuWlD6WrBIS5gphE3D5dvQKd4qXtOJMDtlMB9uasoodvI8Bgj/Xr2iFwX3drlCyhG53NAOOFvPXX55V4hEtdSNMFiQPOjBiyequeCykdzSwdKThfgzq3r+GHnVuw/fAItLsBisQrtEj9Q18uAys+rRiNpgMIj59DYzlwyGbFlErB5URzun9yMdGM1Kz0LKl0PY0SU1Ot2OuV1+jPS4y3ybSvCIy6QhntVOL5/OwxGL4bonJiQasYQUwSC4xJx+3YD6q0epOZsRJzZCFlUWva1v8v4Y+Uf/fH0j2yWwoKe909l4sWapfHpkyA2/ef7jr1C5L+iu7OdRQc+SFUwmKXcN4dyz8XotiCOpSzxxQ6Can8IONuYKGx3gN/qZ0PEQFf7Q+i8TSg7X4Tym9V4KT0RoYodwUEhaPWG44G1C2FBwMyZmVCDh0AxjWZy8BvWT8KfMSA88aWZ3fwfjaPUL5r96NMYKP+kMJ7jKWmocNL9v9dCkfiEEz7GsTRAeITmfwESnkwAlJNz8AAAAABJRU5ErkJggg==" class="mini-brewy-icon" alt=""> Brewy</div><div class="message-bubble">Would you like to try this, or should I adjust something? ü§î</div></div>`;
                    container.scrollTop = container.scrollHeight;
                }, 300);
            }, 500);
            return;
        }

        try {
            const systemPrompt = `You are Brewy, a friendly coffee bean AI barista. Given user preferences, suggest espresso parameters.
            Respond ONLY with valid JSON (no markdown, no explanation):
            {
                "brewTemp": number (85-105),
                "extractionPressure": number (2-12),
                "preInfusionTime": number (0-10),
                "shotVolume": number (10-60),
                "milkType": "None" | "Dairy" | "Oat",
                "milkVolume": number (0-200),
                "frothLevel": number (0-100),
                "recipeName": "string",
                "explanation": "brief friendly explanation"
            }
            Guidelines:
            - Strong/bold = higher pressure (9-10), higher temp (94-96)
            - Smooth/mild = lower pressure (7-8), medium temp (91-93)
            - Latte = milk 150ml, froth 30-50%
            - Cappuccino = milk 100ml, froth 60-80%
            - Hot = higher temp (95-100)`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: userText }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                })
            });

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                const aiParams = JSON.parse(text);
                const container = document.getElementById('chat-messages');
                if (aiParams.explanation) {
                    container.innerHTML += `<div class="message brewy"><div class="message-sender"><img src="data:image/png;base64,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" class="mini-brewy-icon" alt=""> Brewy</div><div class="message-bubble">${aiParams.explanation}</div></div>`;
                }
                setTimeout(() => {
                    addRecipeCard({
                        brewTemp: clamp(aiParams.brewTemp || 93, 85, 105),
                        extractionPressure: clamp(aiParams.extractionPressure || 9, 2, 12),
                        preInfusionTime: clamp(aiParams.preInfusionTime || 3, 0, 10),
                        shotVolume: clamp(aiParams.shotVolume || 36, 10, 60),
                        milkType: aiParams.milkType || 'None',
                        milkVolume: clamp(aiParams.milkVolume || 0, 0, 200),
                        frothLevel: clamp(aiParams.frothLevel || 0, 0, 100)
                    }, aiParams.recipeName || 'Brewy\'s Creation');
                    setTimeout(() => {
                        container.innerHTML += `<div class="message brewy"><div class="message-sender"><img src="data:image/png;base64,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" class="mini-brewy-icon" alt=""> Brewy</div><div class="message-bubble">Would you like to try this, or should I tweak something? üéØ</div></div>`;
                        container.scrollTop = container.scrollHeight;
                    }, 300);
                }, 500);
            } else {
                throw new Error('No response');
            }
        } catch (error) {
            console.error('AI Error:', error);
            // Fallback to rules
            const params = generateParamsFromRules(userText);
            const container = document.getElementById('chat-messages');
            container.innerHTML += `<div class="message brewy"><div class="message-sender"><img src="data:image/png;base64,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" class="mini-brewy-icon" alt=""> Brewy</div><div class="message-bubble">Let me think about that... Here's what I came up with:</div></div>`;
            setTimeout(() => {
                addRecipeCard(params, 'Brewy\'s Suggestion');
                setTimeout(() => {
                    container.innerHTML += `<div class="message brewy"><div class="message-sender"><img src="data:image/png;base64,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" class="mini-brewy-icon" alt=""> Brewy</div><div class="message-bubble">How does this look? I can adjust anything you'd like! üé®</div></div>`;
                    container.scrollTop = container.scrollHeight;
                }, 300);
            }, 500);
        }
    }

    // ============================================
    // RULE-BASED FALLBACK
    // ============================================
    function generateParamsFromRules(text) {
        const lower = text.toLowerCase();
        
        // Start with base params or use context (selected menu item)
        let params;
        if (state.chatContext?.selectedItem && state.pendingRecipe) {
            // User is modifying a selected menu item
            params = { ...state.pendingRecipe };
        } else {
            params = {
                brewTemp: 93,
                extractionPressure: 9,
                preInfusionTime: 3,
                shotVolume: 36,
                milkType: 'None',
                milkVolume: 0,
                frothLevel: 0
            };
        }

        // ==========================================
        // STRENGTH / INTENSITY MAPPING
        // ==========================================
        if (lower.includes('strong') || lower.includes('bold') || lower.includes('intense') || lower.includes('powerful') || lower.includes('robust')) {
            params.brewTemp = clamp(params.brewTemp + 2, 85, 100);
            params.extractionPressure = clamp(params.extractionPressure + 1, 6, 12);
            params.preInfusionTime = clamp(params.preInfusionTime + 1, 0, 10);
            if (params.shotVolume > 25) params.shotVolume = clamp(params.shotVolume - 6, 20, 60);
        } 
        
        if (lower.includes('mild') || lower.includes('smooth') || lower.includes('light') || lower.includes('gentle') || lower.includes('mellow')) {
            params.brewTemp = clamp(params.brewTemp - 2, 85, 100);
            params.extractionPressure = clamp(params.extractionPressure - 1, 6, 12);
            params.preInfusionTime = clamp(params.preInfusionTime + 2, 0, 10);
            params.shotVolume = clamp(params.shotVolume + 4, 20, 60);
        }

        // ==========================================
        // BITTERNESS / ACIDITY MAPPING  
        // ==========================================
        if (lower.includes('bitter') && (lower.includes('less') || lower.includes('no') || lower.includes('not'))) {
            // Less bitter = lower temp, lower pressure, longer pre-infusion
            params.brewTemp = clamp(params.brewTemp - 2, 85, 100);
            params.extractionPressure = clamp(params.extractionPressure - 0.5, 6, 12);
            params.preInfusionTime = clamp(params.preInfusionTime + 2, 0, 10);
        } else if (lower.includes('bitter') && (lower.includes('more') || lower.includes('extra'))) {
            params.brewTemp = clamp(params.brewTemp + 2, 85, 100);
        }

        if (lower.includes('bright') || lower.includes('acidic') || lower.includes('fruity') || lower.includes('citrus')) {
            // Brighter = preserve acids with lower temp, faster extraction
            params.brewTemp = clamp(params.brewTemp - 3, 85, 100);
            params.extractionPressure = clamp(params.extractionPressure - 0.5, 6, 12);
            params.preInfusionTime = clamp(params.preInfusionTime - 1, 0, 10);
        }

        if (lower.includes('sweet') || lower.includes('caramel') || lower.includes('chocolate') || lower.includes('nutty')) {
            // Sweeter notes = balanced extraction
            params.brewTemp = clamp(93, 85, 100);
            params.extractionPressure = clamp(8.5, 6, 12);
            params.preInfusionTime = clamp(4, 0, 10);
        }

        // ==========================================
        // TEMPERATURE MODIFIERS
        // ==========================================
        if (lower.includes('hot') || lower.includes('extra hot') || lower.includes('very hot')) {
            params.brewTemp = clamp(params.brewTemp + 4, 85, 100);
        } else if (lower.includes('warm') || lower.includes('not too hot') || lower.includes('cooler')) {
            params.brewTemp = clamp(params.brewTemp - 4, 85, 100);
        }

        // ==========================================
        // MILK DRINKS DETECTION
        // ==========================================
        if (lower.includes('latte')) {
            params.milkType = lower.includes('oat') ? 'Oat' : 'Dairy';
            params.milkVolume = 150;
            params.frothLevel = 40;
        } else if (lower.includes('cappuccino')) {
            params.milkType = 'Dairy';
            params.milkVolume = 100;
            params.frothLevel = 70;
        } else if (lower.includes('flat white')) {
            params.milkType = 'Dairy';
            params.milkVolume = 120;
            params.frothLevel = 20;
        } else if (lower.includes('cortado')) {
            params.milkType = 'Dairy';
            params.milkVolume = 60;
            params.frothLevel = 10;
        } else if (lower.includes('macchiato')) {
            params.milkType = 'Dairy';
            params.milkVolume = 30;
            params.frothLevel = 80;
        } else if (lower.includes('oat') || lower.includes('oatmilk') || lower.includes('oat milk')) {
            params.milkType = 'Oat';
            if (params.milkVolume === 0) params.milkVolume = 120;
            if (params.frothLevel === 0) params.frothLevel = 40;
        } else if (lower.includes('dairy') || (lower.includes('milk') && !lower.includes('no milk'))) {
            params.milkType = 'Dairy';
            if (params.milkVolume === 0) params.milkVolume = 100;
            if (params.frothLevel === 0) params.frothLevel = 30;
        }

        // ==========================================
        // MILK QUANTITY MODIFIERS
        // ==========================================
        if (lower.includes('extra milk') || lower.includes('more milk')) {
            params.milkVolume = clamp(params.milkVolume + 50, 0, 200);
        } else if (lower.includes('less milk') || lower.includes('light milk')) {
            params.milkVolume = clamp(params.milkVolume - 40, 0, 200);
        } else if (lower.includes('no milk') || lower.includes('black')) {
            params.milkType = 'None';
            params.milkVolume = 0;
            params.frothLevel = 0;
        }

        // ==========================================
        // FROTH / FOAM MODIFIERS
        // ==========================================
        if (lower.includes('foamy') || lower.includes('frothy') || lower.includes('extra foam') || lower.includes('more foam')) {
            params.frothLevel = clamp(params.frothLevel + 30, 0, 100);
            if (params.milkType === 'None') { params.milkType = 'Dairy'; params.milkVolume = 100; }
        } else if (lower.includes('no foam') || lower.includes('flat') || lower.includes('less foam')) {
            params.frothLevel = clamp(params.frothLevel - 30, 0, 100);
        }

        // ==========================================
        // SHOT SIZE / VOLUME
        // ==========================================
        if (lower.includes('ristretto')) {
            params.shotVolume = 20;
            params.extractionPressure = clamp(params.extractionPressure + 0.5, 6, 12);
        } else if (lower.includes('lungo') || lower.includes('long')) {
            params.shotVolume = 50;
            params.extractionPressure = clamp(params.extractionPressure - 0.5, 6, 12);
        } else if (lower.includes('double') || lower.includes('large') || lower.includes('bigger')) {
            params.shotVolume = clamp(params.shotVolume + 15, 20, 60);
        } else if (lower.includes('single') || lower.includes('small') || lower.includes('smaller')) {
            params.shotVolume = clamp(params.shotVolume - 10, 15, 60);
        }

        return params;
    }

    // ==========================================
    // AI INTERPRETATION DOCUMENTATION
    // ==========================================
    /*
     * HOW THE AI MAPS NATURAL LANGUAGE TO PARAMETERS:
     * 
     * The system uses a "Taste Graph" concept from the PRD:
     * 1. User intent keywords ‚Üí mapped to extraction science
     * 2. Each parameter affects specific flavor compounds
     * 3. Changes stay within "shop-approved guardrails" (clamp function)
     * 
     * EXTRACTION SCIENCE:
     * - Temperature: Higher = more solubles extracted (including bitter)
     * - Pressure: Higher = faster extraction, more crema, more intensity  
     * - Pre-infusion: Longer = more even saturation, less channeling
     * - Volume: Less water = concentrated (ristretto), more = diluted (lungo)
     * 
     * FLAVOR OUTCOMES:
     * - "Stronger" ‚Üí More extraction + concentration
     * - "Smoother" ‚Üí Gentler extraction + dilution
     * - "Brighter" ‚Üí Preserve acids, avoid over-extraction
     * - "Less bitter" ‚Üí Lower temp, gentle pressure, even extraction
     * 
     * GUARDRAILS (per PRD Section 7.1):
     * - brewTemp: 85-105¬∞C (shop can narrow this)
     * - extractionPressure: 6-12 bar
     * - preInfusionTime: 0-10 seconds
     * - shotVolume: 15-60ml
     */
    // ============================================
    // DOCUMENT READY - INITIALIZE APP
    // ============================================
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
